---
import Layout from "../layouts/Layout.astro";
---

<Layout title="You're Invited!">
  <div class="welcome-wrapper">
    <h1>You're Invited!</h1>

    <p>
      We're so excited to have you celebrate with us on our special day.
      Enter your email and the 8-digit code from your invite email to confirm
      your place and RSVP.
    </p>

    <div id="statusBox" class="status-box hidden" role="status" aria-live="polite">
      <p id="statusText"></p>
    </div>

    <!-- Step 1: Email entry -->
    <form id="emailForm" class="welcome-form">
      <label class="field">
        <span class="field-label">Email address</span>
        <input
          id="email"
          class="field-input"
          type="email"
          autocomplete="email"
          required
          placeholder="you@example.com"
        />
      </label>

      <button id="nextBtn" class="nav-button" type="submit">
        Next
      </button>
    </form>

    <!-- Step 2: OTP code entry (hidden initially) -->
    <form id="otpForm" class="welcome-form hidden">
      <p class="otp-instructions">
        Enter the 8-digit code from your invite email for
        <strong id="sentToEmail"></strong>.
      </p>

      <label class="field">
        <span class="field-label">Invite code</span>
        <input
          id="otpCode"
          class="field-input otp-input"
          type="text"
          inputmode="numeric"
          autocomplete="one-time-code"
          pattern="[0-9]{8}"
          maxlength="8"
          required
          placeholder="00000000"
        />
      </label>

      <div class="button-group">
        <button id="verifyBtn" class="nav-button" type="submit">
          Confirm
        </button>

        <button id="backBtn" class="nav-button" type="button">
          Use a different email
        </button>
      </div>

      <p class="resend-row">
        Lost your code?
        <button id="resendBtn" type="button" class="link-button">
          Send a new code
        </button>
        <span class="resend-note">(this sends a fresh sign-in code to your email)</span>
      </p>
    </form>

    <p class="returning-user">
      Already confirmed before?
      <a href="/login-error">Sign in here instead.</a>
    </p>
  </div>

  <script>
    import { supabase } from "../lib/supabaseClient";

    // — Elements —
    const emailForm = document.getElementById("emailForm") as HTMLFormElement;
    const otpForm = document.getElementById("otpForm") as HTMLFormElement;
    const emailEl = document.getElementById("email") as HTMLInputElement;
    const otpCodeEl = document.getElementById("otpCode") as HTMLInputElement;
    const statusBox = document.getElementById("statusBox") as HTMLDivElement;
    const statusText = document.getElementById("statusText") as HTMLParagraphElement;
    const nextBtn = document.getElementById("nextBtn") as HTMLButtonElement;
    const verifyBtn = document.getElementById("verifyBtn") as HTMLButtonElement;
    const backBtn = document.getElementById("backBtn") as HTMLButtonElement;
    const resendBtn = document.getElementById("resendBtn") as HTMLButtonElement;
    const sentToEmail = document.getElementById("sentToEmail") as HTMLElement;

    let currentEmail = "";
    let resendCooldown = false;

    // — Helpers —
    function showStatus(text: string, isError = false) {
      statusBox.classList.remove("hidden");
      statusText.textContent = text;
      statusText.style.fontWeight = isError ? "600" : "400";
    }

    function hideStatus() {
      statusBox.classList.add("hidden");
    }

    function showStep(step: "email" | "otp") {
      if (step === "email") {
        emailForm.classList.remove("hidden");
        otpForm.classList.add("hidden");
      } else {
        emailForm.classList.add("hidden");
        otpForm.classList.remove("hidden");
        otpCodeEl.value = "";
        otpCodeEl.focus();
      }
    }

    function startResendCooldown() {
      resendCooldown = true;
      resendBtn.disabled = true;
      let seconds = 60;
      resendBtn.textContent = `Send a new code (${seconds}s)`;
      const timer = setInterval(() => {
        seconds -= 1;
        if (seconds <= 0) {
          clearInterval(timer);
          resendCooldown = false;
          resendBtn.disabled = false;
          resendBtn.textContent = "Send a new code";
        } else {
          resendBtn.textContent = `Send a new code (${seconds}s)`;
        }
      }, 1000);
    }

    // — Step 1: Capture email and move to code entry —
    emailForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = emailEl.value.trim().toLowerCase();
      if (!email) return;

      currentEmail = email;
      sentToEmail.textContent = email;
      hideStatus();
      showStep("otp");
    });

    // — Step 2: Verify invite OTP —
    otpForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const code = otpCodeEl.value.trim();
      if (!code || !currentEmail) return;

      verifyBtn.disabled = true;
      verifyBtn.textContent = "Verifying…";
      hideStatus();

      try {
        const { error } = await supabase.auth.verifyOtp({
          email: currentEmail,
          token: code,
          type: "invite",
        });

        if (error) throw error;

        showStatus("Welcome! Redirecting…");
        window.location.replace("/rsvp");
      } catch (err: any) {
        showStatus(
          "Invalid or expired code. Please try again or request a new one.",
          true
        );
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = "Confirm";
      }
    });

    // — Back button —
    backBtn.addEventListener("click", () => {
      hideStatus();
      showStep("email");
    });

    // — Resend code (sends a fresh OTP via signInWithOtp) —
    resendBtn.addEventListener("click", async () => {
      if (!currentEmail || resendCooldown) return;
      resendBtn.disabled = true;
      resendBtn.textContent = "Sending…";
      hideStatus();

      try {
        const { error } = await supabase.auth.signInWithOtp({
          email: currentEmail,
          options: { shouldCreateUser: false },
        });
        if (error) throw error;

        showStatus("New code sent — check your email.");
        startResendCooldown();
      } catch (err: any) {
        showStatus(`Couldn't resend: ${err.message ?? err}`, true);
        resendBtn.disabled = false;
        resendBtn.textContent = "Send a new code";
      }
    });
  </script>
</Layout>

<style>
  .hidden {
    display: none !important;
  }

  .welcome-wrapper {
    max-width: 40rem;
    margin: 0 auto;
  }

  .status-box {
    margin-top: 1.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid currentColor;
    border-radius: 0.5rem;
  }

  .welcome-form {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .field {
    display: block;
  }

  .field-label {
    display: block;
    margin-bottom: 0.35rem;
    font-family: "Lanenar", sans-serif;
  }

  .field-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid currentColor;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    background: transparent;
    box-sizing: border-box;
  }

  .field-input:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  .otp-input {
    font-size: 1.5rem;
    letter-spacing: 0.5em;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  .otp-instructions {
    line-height: 1.5;
  }

  .button-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .resend-row {
    font-size: 0.9em;
  }

  .resend-note {
    font-size: 0.85em;
    opacity: 0.7;
  }

  .link-button {
    background: none;
    border: none;
    color: inherit;
    text-decoration: underline;
    cursor: pointer;
    font: inherit;
    font-size: inherit;
    padding: 0;
  }

  .link-button:hover {
    opacity: 0.7;
  }

  .link-button:disabled {
    opacity: 0.5;
    cursor: default;
  }

  .returning-user {
    margin-top: 2rem;
    font-size: 0.9em;
  }
</style>
