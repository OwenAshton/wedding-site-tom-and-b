---
import Layout from "../layouts/Layout.astro";
const siteUrl = import.meta.env.SITE_URL;
---

<Layout title="Sign-in issue">
  <div class="login-error-wrapper">
    <h1>Sign-in issue</h1>

    <p>
      We couldn't sign you in to the website.
    </p>

    <p>
      Enter your email below and we'll send you a sign-in code.
    </p>

    <div id="statusBox" class="status-box hidden" role="status" aria-live="polite">
      <p id="statusText"></p>
    </div>

    <!-- Step 1: Email entry -->
    <form id="emailForm" class="login-form">
      <label class="field">
        <span class="field-label">Email address</span>
        <input
          id="email"
          class="field-input"
          type="email"
          autocomplete="email"
          required
          placeholder="you@example.com"
        />
      </label>

      <div class="button-group">
        <button id="sendBtn" class="nav-button" type="submit">
          Send sign-in code
        </button>

        <button id="signOut" class="nav-button" type="button">
          Clear session
        </button>
      </div>
    </form>

    <!-- Step 2: OTP code entry (hidden initially) -->
    <form id="otpForm" class="login-form hidden">
      <p class="otp-instructions">
        We sent an 8-digit code to <strong id="sentToEmail"></strong>.
        <br />Check your inbox and enter it below.
      </p>

      <label class="field">
        <span class="field-label">Sign-in code</span>
        <input
          id="otpCode"
          class="field-input otp-input"
          type="text"
          inputmode="numeric"
          autocomplete="one-time-code"
          pattern="[0-9]{8}"
          maxlength="8"
          required
          placeholder="00000000"
        />
      </label>

      <div class="button-group">
        <button id="verifyBtn" class="nav-button" type="submit">
          Verify code
        </button>

        <button id="backBtn" class="nav-button" type="button">
          Use a different email
        </button>
      </div>

      <p class="resend-row">
        Didn't get the email?
        <button id="resendBtn" type="button" class="link-button">
          Send a new code
        </button>
      </p>
    </form>
  </div>

  <script>
    import { supabase } from "../lib/supabaseClient";

    // — Elements —
    const emailForm = document.getElementById("emailForm") as HTMLFormElement;
    const otpForm = document.getElementById("otpForm") as HTMLFormElement;
    const emailEl = document.getElementById("email") as HTMLInputElement;
    const otpCodeEl = document.getElementById("otpCode") as HTMLInputElement;
    const statusBox = document.getElementById("statusBox") as HTMLDivElement;
    const statusText = document.getElementById("statusText") as HTMLParagraphElement;
    const sendBtn = document.getElementById("sendBtn") as HTMLButtonElement;
    const verifyBtn = document.getElementById("verifyBtn") as HTMLButtonElement;
    const backBtn = document.getElementById("backBtn") as HTMLButtonElement;
    const resendBtn = document.getElementById("resendBtn") as HTMLButtonElement;
    const sentToEmail = document.getElementById("sentToEmail") as HTMLElement;

    let currentEmail = "";

    // — Helpers —
    function showStatus(text: string, isError = false) {
      statusBox.classList.remove("hidden");
      statusText.textContent = text;
      statusText.style.fontWeight = isError ? "600" : "400";
    }

    function hideStatus() {
      statusBox.classList.add("hidden");
    }

    function showStep(step: "email" | "otp") {
      if (step === "email") {
        emailForm.classList.remove("hidden");
        otpForm.classList.add("hidden");
      } else {
        emailForm.classList.add("hidden");
        otpForm.classList.remove("hidden");
        otpCodeEl.value = "";
        otpCodeEl.focus();
      }
    }

    // — Sign out —
    document.getElementById("signOut")!.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.reload();
    });

    // — Step 1: Request OTP —
    async function requestOtp(email: string) {
      // Check guest list first
      const { data: invited, error: invitedErr } = await supabase.rpc(
        "is_invited",
        { p_email: email }
      );
      if (invitedErr) throw invitedErr;
      if (!invited) {
        window.location.replace("/not-invited");
        return false;
      }

      // Send OTP code (not a magic link — requires email template change)
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          shouldCreateUser: false,
        },
      });
      if (error) throw error;
      return true;
    }

    emailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = emailEl.value.trim().toLowerCase();
      if (!email) return;

      sendBtn.disabled = true;
      sendBtn.textContent = "Sending…";
      hideStatus();

      try {
        const sent = await requestOtp(email);
        if (!sent) return; // redirected to /not-invited

        currentEmail = email;
        sentToEmail.textContent = email;
        showStep("otp");
        showStatus("Code sent — check your email.");
      } catch (err: any) {
        showStatus(
          `Sorry — something went wrong: ${err.message ?? err}`,
          true
        );
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send sign-in code";
      }
    });

    // — Step 2: Verify OTP —
    otpForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const code = otpCodeEl.value.trim();
      if (!code || !currentEmail) return;

      verifyBtn.disabled = true;
      verifyBtn.textContent = "Verifying…";
      hideStatus();

      try {
        const { data, error } = await supabase.auth.verifyOtp({
          email: currentEmail,
          token: code,
          type: "email",
        });

        if (error) throw error;

        // Success — redirect to RSVP (or wherever makes sense)
        showStatus("Signed in! Redirecting…");
        window.location.replace("/rsvp");
      } catch (err: any) {
        showStatus(
          `Invalid or expired code. Please try again or request a new one.`,
          true
        );
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = "Verify code";
      }
    });

    // — Back button —
    backBtn.addEventListener("click", () => {
      hideStatus();
      showStep("email");
    });

    // — Resend code —
    resendBtn.addEventListener("click", async () => {
      if (!currentEmail) return;
      resendBtn.disabled = true;
      resendBtn.textContent = "Sending…";
      hideStatus();

      try {
        await requestOtp(currentEmail);
        showStatus("New code sent — check your email.");
      } catch (err: any) {
        showStatus(`Couldn't resend: ${err.message ?? err}`, true);
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = "Send a new code";
      }
    });
  </script>
</Layout>

<style>
  .hidden {
    display: none !important;
  }

  .login-error-wrapper {
    max-width: 40rem;
    margin: 0 auto;
  }

  .status-box {
    margin-top: 1.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid currentColor;
    border-radius: 0.5rem;
  }

  .login-form {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .field {
    display: block;
  }

  .field-label {
    display: block;
    margin-bottom: 0.35rem;
    font-family: "Lanenar", sans-serif;
  }

  .field-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid currentColor;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    background: transparent;
    box-sizing: border-box;
  }

  .field-input:focus {
    outline: 2px solid currentColor;
    outline-offset: 2px;
  }

  .otp-input {
    font-size: 1.5rem;
    letter-spacing: 0.5em;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  .otp-instructions {
    line-height: 1.5;
  }

  .button-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .resend-row {
    font-size: 0.9em;
  }

  .link-button {
    background: none;
    border: none;
    color: inherit;
    text-decoration: underline;
    cursor: pointer;
    font: inherit;
    font-size: inherit;
    padding: 0;
  }

  .link-button:hover {
    opacity: 0.7;
  }

  .link-button:disabled {
    opacity: 0.5;
    cursor: default;
  }
</style>